{% extends "oscar/checkout/checkout.html" %}
{% load purchase_info_tags %}
{% load currency_filters %}
{% load static %}
{% load i18n %}


{% block title %}
    {% trans "Payment details" %} | {{ block.super }}
{% endblock %}

{% block checkout_nav %}
    {% include 'oscar/checkout/nav.html' with step=4 %}
{% endblock %}

{% block checkout_title %}{% trans "Enter payment details" %}{% endblock %}

{% block order_contents %}
<h4 class="title text-uppercase ls-25 mb-5">{% trans "Order Details" %}</h4>
<table class="order-table mb-5">
    <thead>
        <tr>
            <th class="text-dark">{% trans 'Product' %}</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for line in basket.all_lines %}
             {% purchase_info_for_line request line as session %}
            <tr>
                <td> 
                    <a href="{{ line.product.get_absolute_url }}">{{ line.description|slice:":10" }}</a>&nbsp;<strong>x {{ line.quantity }}</strong><br>
                    {% trans "Vendor" %} : <a href="#">{{ line.product.partner.name }}</a>
                </td>
                <td>
                    {% if not show_tax_separately and line.is_tax_known %}
                        {{ line.line_price_incl_tax|currency:basket.currency }}
                    {% else %}
                        {{ line.line_price_excl_tax|currency:basket.currency }}
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
    </tbody>
    <tfoot>
        <tr>
            <th>{% trans "Subtotal:" %}</th>
            <td>{{ request.basket.total_incl_tax|currency:request.basket.currency }}</td>
        </tr>
        <tr>
            <th>{% trans "Shipping:" %}</th>
            <td>
                {% if not shipping_method.is_discounted %}
                    {% if not show_tax_separately and shipping_charge.is_tax_known %}
                        {{ shipping_charge.incl_tax|currency:basket.currency }}
                    {% else %}
                        {{ shipping_charge.excl_tax|currency:basket.currency }}
                    {% endif %}
                {% else %}
                    {% if not show_tax_separately and shipping_charge_excl_discount.is_tax_known %}
                        {{ shipping_charge_excl_discount.incl_tax|currency:basket.currency }}
                    {% else %}
                        {{ shipping_charge_excl_discount.excl_tax|currency:basket.currency }}
                    {% endif %}
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>{% trans "Payment method:" %}</th>
            <td>{% trans 'No publish' %}</td>
        </tr>
        <tr class="total">
            <th class="border-no">{% trans "Total:" %}</th>
            <td class="border-no">
                {% if order_total.is_tax_known %}
                    {{ order_total.incl_tax|currency:basket.currency }}
                {% else %}
                    {{ order_total.excl_tax|currency:basket.currency }}
                {% endif %}
            </td>
        </tr>
    </tfoot>
</table>
{% endblock %}

{% block shipping_address %}{% endblock %}
{% block shipping_method %}{% endblock %}
{% block payment_method %}{% endblock %}

{% block payment_details %}
    {% block payment_details_content %}
    <div class="container">
        
        <!-- Payment Method Selection -->
        <h4 class="title text-uppercase ls-25 mb-5">{% trans "Select Payment Method" %}</h4>
        <form method="POST" class="mb-4">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="payment_method" id="razorpay" value="razorpay" 
                               {% if payment_method == 'razorpay' %}checked{% endif %} onchange="this.form.submit()">
                        <label class="form-check-label" for="razorpay">
                            <strong>{% trans "Online Payment (Razorpay)" %}</strong><br>
                            <small class="text-muted">{% trans "Pay securely using credit/debit card, UPI, net banking" %}</small>
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod"
                               {% if payment_method == 'cod' %}checked{% endif %} onchange="this.form.submit()">
                        <label class="form-check-label" for="cod">
                            <strong>{% trans "Cash on Delivery (COD)" %}</strong><br>
                            <small class="text-muted">{% trans "Pay when your order is delivered" %}</small>
                        </label>
                    </div>
                </div>
            </div>
        </form>

        <!-- Razorpay Payment Section -->
        {% if payment_method == 'razorpay' %}
        <div id="razorpay-section">
            <h5 class="mb-3">{% trans "Complete Your Payment" %}</h5>
            <form id="razorpay-form" action="{% url 'checkout:payment-details' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="place_order">
                <input type="hidden" name="payment_method" value="razorpay">
                <input type="hidden" name="razorpay_payment_id" id="razorpay-payment-id">
                <input type="hidden" name="razorpay_order_id" id="razorpay-order-id" value="{{ razorpay_order_id }}">
                <input type="hidden" name="razorpay_signature" id="razorpay-signature">
                <button type="button" class="btn btn-success btn-lg" id="rzp-button1">
                    <i class="fas fa-credit-card"></i> {% trans "Pay Now" %} - {{ order_total.incl_tax|currency:basket.currency }}
                </button>
            </form>

            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                var options = {
                    "key": "{{ razorpay_key }}",
                    "amount": {{ basket_total }},
                    "currency": "INR",
                    "name": "Oscar E-commerce",
                    "description": "Order #{{ order_number }}",
                    "order_id": "{{ razorpay_order_id }}",
                    "handler": function (response){
                        document.getElementById('razorpay-payment-id').value = response.razorpay_payment_id;
                        document.getElementById('razorpay-order-id').value = response.razorpay_order_id;
                        document.getElementById('razorpay-signature').value = response.razorpay_signature;
                        document.getElementById('razorpay-form').submit();
                    },
                    "prefill": {
                        "name": "{{ user.get_full_name|default:'' }}",
                        "email": "{{ user_email|default:'' }}",
                        "contact": "{{ shipping_address.phone_number|default:'' }}"
                    },
                    "modal": {
                        "ondismiss": function(){
                        }
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };
                
                
                // Check if Razorpay is loaded
                if (typeof Razorpay === 'undefined') {
                    console.error('Razorpay library not loaded!');
                    alert('Razorpay library not loaded. Please refresh the page.');
                    return;
                }
                
                // Validate required fields
                if (!options.key || !options.amount || !options.order_id) {
                    console.error('Missing required payment data:', {
                        key: !!options.key,
                        amount: !!options.amount,
                        order_id: !!options.order_id
                    });
                    alert('Payment configuration error. Please refresh and try again.');
                    return;
                }
                
                if (options.amount <= 0) {
                    console.error('Invalid amount:', options.amount);
                    alert('Invalid payment amount. Please refresh and try again.');
                    return;
                }
                
                var rzp1;
                try {
                    rzp1 = new Razorpay(options);
                } catch (error) {
                    console.error('Error creating Razorpay instance:', error);
                    alert('Error initializing payment gateway. Please try again.');
                    return;
                }
                
                rzp1.on('payment.failed', function (response){
                    console.error('Payment failed:', response.error);
                    console.error('Error code:', response.error.code);
                    console.error('Error description:', response.error.description);
                    console.error('Error reason:', response.error.reason);
                    console.error('Full error object:', response.error);
                    
                    var errorMsg = 'Payment failed: ' + response.error.description;
                    
                    // Handle specific Razorpay errors
                    if (response.error.description === 'Please use another method') {
                        errorMsg += '\n\nThis may be due to:\n' +
                                   '• Payment method not enabled in test mode\n' +
                                   '• Try different card details\n' +
                                   '• Use Cash on Delivery instead\n\n' +
                                   'Test cards that usually work:\n' +
                                   '• 4111111111111111 (Visa)\n' +
                                   '• 5555555555554444 (Mastercard)';
                    }
                    
                    if (response.error.reason) {
                        errorMsg += '\nReason: ' + response.error.reason;
                    }
                    if (response.error.code) {
                        errorMsg += '\nCode: ' + response.error.code;
                    }
                    
                    alert(errorMsg);
                });
                
                var payButton = document.getElementById('rzp-button1');
                if (payButton) {
                    payButton.onclick = function(e){
                        e.preventDefault();
                        rzp1.open();
                    };
                } else {
                    console.error('Pay button not found!');
                }
            });
            </script>
            
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle"></i> {% trans "Click 'Pay Now' to complete your payment securely through Razorpay" %}
            </div>
            
        </div>
        {% endif %}

        <!-- COD Section -->
        {% if payment_method == 'cod' %}
        <div id="cod-section">
            <h5 class="mb-3">{% trans "Cash on Delivery" %}</h5>
            <div class="alert alert-warning">
                <i class="fas fa-money-bill-wave"></i> 
                {% trans "You have selected Cash on Delivery. You will pay" %} 
                <strong>{{ order_total.incl_tax|currency:basket.currency }}</strong> 
                {% trans "when your order is delivered." %}
            </div>
            
            <form action="{% url 'checkout:payment-details' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="place_order">
                <input type="hidden" name="payment_method" value="cod">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-arrow-right"></i> {% trans "Place Order" %}
                </button>
            </form>
        </div>
        {% endif %}
    
    </div>
    {% endblock payment_details_content %}
{% endblock payment_details %}
